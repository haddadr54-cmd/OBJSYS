import{r as a,x as A,y as C,V as v}from"./index-CCr23udO.js";function T(m={}){const{enabled:t=!0,initialFetch:l=!0}=m,[w,s]=a.useState([]),[h,f]=a.useState(!!l),[y,_]=a.useState(null),n=a.useRef(new Map),R=a.useRef(!1),d=a.useRef([]),p=a.useCallback(r=>{n.current.clear(),r.forEach(e=>n.current.set(e.id,e)),s(Array.from(n.current.values()).sort((e,o)=>o.data_envio.localeCompare(e.data_envio)))},[]),E=a.useCallback(()=>{if(d.current.length===0)return;const r=n.current;for(const e of d.current)e.action==="INSERT"&&e.newRecord||e.action==="UPDATE"&&e.newRecord?r.set(e.newRecord.id,e.newRecord):e.action==="DELETE"&&e.oldRecord&&r.delete(e.oldRecord.id);d.current=[],s(Array.from(r.values()).sort((e,o)=>o.data_envio.localeCompare(e.data_envio)))},[]),u=a.useCallback(async()=>{if(t)try{f(!0);const{data:r,error:e}=await A.from("recados").select("*, autor:usuarios!enviado_por(*)").order("data_envio",{ascending:!1});if(e)throw e;p(r||[]),R.current=!0,E()}catch(r){_(r.message||"Erro ao carregar recados")}finally{f(!1)}},[p,t,E]);return C("recados",r=>{var o,i;if(!t)return;if(!R.current){d.current.push(r);return}const e=n.current;if(r.action==="INSERT"&&r.newRecord)e.set(r.newRecord.id,r.newRecord);else if(r.action==="UPDATE"&&r.newRecord)e.set(r.newRecord.id,r.newRecord);else if(r.action==="DELETE"){const c=((o=r.oldRecord)==null?void 0:o.id)||((i=r.newRecord)==null?void 0:i.id);c&&e.delete(c)}s(Array.from(e.values()).sort((c,g)=>g.data_envio.localeCompare(c.data_envio)))}),a.useEffect(()=>{if(!t)return;const r=v(({id:e})=>{const o=n.current;o.has(e)&&(o.delete(e),s(Array.from(o.values()).sort((i,c)=>c.data_envio.localeCompare(i.data_envio))))});return()=>{r()}},[t]),a.useEffect(()=>{t&&l&&u()},[t,l,u]),{recados:w,loading:h,error:y,refetch:u}}export{T as u};
