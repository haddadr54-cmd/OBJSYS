import{u as re,d as te,r as l,j as e,t as y,Z as ne,a as P,B as O,C as V,I as S,X as k}from"./index-CCr23udO.js";import{S as le}from"./save-BDGo1Gz5.js";import{F as ie}from"./filter-ClytLayh.js";import{U as ce}from"./user-check-Gjly-lFN.js";import{U as oe}from"./user-x-Dbdoo9ik.js";function ue(){var L,R,z;const{user:x,isSupabaseConnected:C}=re(),c=te(x,C),[f,X]=l.useState([]),[E,Z]=l.useState([]),[r,A]=l.useState(""),[o,Q]=l.useState(new Date().toISOString().split("T")[0]),[g,m]=l.useState([]),[G,H]=l.useState(!0),[D,T]=l.useState(!1),[i,j]=l.useState(""),[$,v]=l.useState([]),[J,K]=l.useState([]),[p,W]=l.useState(!1),[I,_]=l.useState(null);l.useEffect(()=>{x&&ee()},[x,C]),l.useEffect(()=>{r&&c&&x&&Y()},[r,c,x]),l.useEffect(()=>{r&&i&&o&&B()},[r,i,o]);const Y=async()=>{if(!(!c||!r||!x))try{console.log("üîç [PresencaPage] Carregando disciplinas para turma:",r);const s=await c.getDisciplinas();if(console.log("üîç [PresencaPage] Total disciplinas:",(s==null?void 0:s.length)||0),!s){console.warn("‚ö†Ô∏è [PresencaPage] Nenhuma disciplina retornada pelo dataService"),v([]);return}const t=s.filter(a=>(console.log("üîç [PresencaPage] Verificando disciplina:",{nome:a.nome,turma_id:a.turma_id,professor_id:a.professor_id,turmaSelected:r,userId:x.id}),a.turma_id===r));console.log("üîç [PresencaPage] Disciplinas da turma encontradas:",t.length),v(t),t.length===1&&(j(t[0].id),console.log("üîç [PresencaPage] Auto-selecionada disciplina:",t[0].nome))}catch(s){console.error("‚ùå [PresencaPage] Erro ao carregar disciplinas:",s),v([])}},ee=async()=>{try{const[s,t]=await Promise.all([c.getTurmas(),c.getAlunos()]);X(s),Z(t),s.length>0&&!r&&A(s[0].id)}catch(s){console.error("Erro ao carregar dados:",s)}finally{H(!1)}},B=async()=>{try{console.log("üîÑ [PresencaPage] Carregando presen√ßas existentes...",{turmaSelected:r,dataSelected:o,disciplinaSelected:i});const s=await c.getPresencasByTurmaData(r,o,i);console.log("‚úÖ [PresencaPage] Presen√ßas carregadas:",{quantidade:s.length,presencas:s}),K(s),F(s)}catch(s){console.error("‚ùå [PresencaPage] Erro ao carregar presen√ßas existentes:",s),F([])}},F=(s=[])=>{const a=E.filter(n=>n.turma_id===r).map(n=>{const u=s.find(q=>q.aluno_id===n.id);return{alunoId:n.id,presente:u?u.presente:!0,justificativa:""}});m(a)},M=s=>{m(t=>t.map(a=>({...a,presente:s}))),_(s?"todos-presentes":"todos-ausentes"),setTimeout(()=>_(null),1e3)},N=(s,t)=>{m(a=>a.map(n=>n.alunoId===s?{...n,presente:t}:n))},se=async()=>{if(!i){alert("Selecione uma disciplina antes de salvar as presen√ßas");return}T(!0);try{console.log("üíæ [PresencaPage] Iniciando salvamento de presen√ßas...",{totalPresencas:g.length,disciplinaSelected:i,dataSelected:o});const s=5;let t=0,a=0,n=0;const u=g.map(d=>async()=>{const b=J.find(w=>w.aluno_id===d.alunoId);try{b?(console.log(`üîÑ [PresencaPage] Atualizando presen√ßa existente - Aluno: ${d.alunoId}`),await c.updatePresenca(b.id,{presente:d.presente})):(console.log(`‚ûï [PresencaPage] Criando nova presen√ßa - Aluno: ${d.alunoId}`),await c.createPresenca({aluno_id:d.alunoId,data_aula:o,presente:d.presente,disciplina_id:i})),a++}catch(w){console.error(`‚ùå [PresencaPage] Erro ao salvar presen√ßa do aluno ${d.alunoId}:`,w),n++}});await(async()=>{for(;t<u.length;){const d=u.slice(t,t+s).map(b=>b());t+=s,await Promise.all(d)}})(),console.log("üìä [PresencaPage] Salvamento conclu√≠do:",{sucessos:a,erros:n}),alert(n===0?`‚úÖ Todas as presen√ßas foram salvas com sucesso! (${a} registros)`:a===0?"‚ùå Falha ao salvar todas as presen√ßas. Verifique a conex√£o.":`‚ö†Ô∏è Presen√ßas salvas parcialmente: ${a} sucessos, ${n} erros`),await B()}catch(s){console.error("Erro ao salvar presen√ßas:",s),alert("‚ùå Erro geral ao salvar presen√ßas: "+s.message)}finally{T(!1)}},h=E.filter(s=>s.turma_id===r),U=g.filter(s=>s.presente).length,ae=g.filter(s=>!s.presente).length;return G?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg",children:e.jsx(y,{className:"h-8 w-8 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent",children:"‚úÖ Controle de Presen√ßa"}),e.jsx("p",{className:"text-gray-600 text-lg font-medium",children:"Sistema r√°pido e eficiente"})]}),e.jsxs("div",{className:"flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded-2xl text-sm font-black shadow-lg",children:[e.jsx(ne,{className:"h-5 w-5"}),e.jsx("span",{children:"‚ö° Sistema R√°pido"})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:r&&i&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>W(!p),className:`px-4 py-2 rounded-lg transition-colors ${p?"bg-orange-100 text-orange-700 hover:bg-orange-200":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:p?"Modo Normal":"Modo R√°pido"}),e.jsxs("button",{onClick:se,disabled:D,className:"flex items-center space-x-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 shadow-lg",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{children:D?"Salvando...":"Salvar Presen√ßas"})]})]})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(ie,{className:"h-5 w-5 text-gray-500"}),e.jsx("h3",{className:"font-medium text-gray-900",children:"Sele√ß√£o"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Turma"}),e.jsxs("select",{value:r,onChange:s=>{A(s.target.value),j(""),m([])},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"Selecione uma turma"}),f.map(s=>e.jsx("option",{value:s.id,children:s.nome},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Disciplina"}),e.jsxs("select",{value:i,onChange:s=>{j(s.target.value),m([])},disabled:!r,className:`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${r?"":"bg-gray-50 cursor-not-allowed"}`,children:[e.jsx("option",{value:"",children:"Selecione uma disciplina"}),$.map(s=>e.jsx("option",{value:s.id,children:s.nome},s.id))]})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Data da Aula"}),e.jsx("input",{type:"date",value:o,onChange:s=>{Q(s.target.value),m([])},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})})]}),r&&e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(P,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:(L=f.find(s=>s.id===r))==null?void 0:L.nome})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:(R=$.find(s=>s.id===i))==null?void 0:R.nome})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800",children:new Date(o).toLocaleDateString("pt-BR")})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border-2 border-gray-200 p-6 hover:shadow-2xl transition-all duration-300 hover:scale-110",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-black text-gray-600 uppercase tracking-wide",children:"üë• Total"}),e.jsx("p",{className:"text-3xl font-black text-gray-700",children:h.length})]}),e.jsx("div",{className:"p-3 bg-gradient-to-br from-gray-400 to-gray-600 rounded-2xl shadow-lg",children:e.jsx(P,{className:"h-8 w-8 text-white"})})]})}),e.jsx("div",{className:"bg-gradient-to-br from-white to-green-50 rounded-2xl shadow-xl border-2 border-green-200 p-6 hover:shadow-2xl transition-all duration-300 hover:scale-110",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-black text-green-600 uppercase tracking-wide",children:"‚úÖ Presentes"}),e.jsx("p",{className:"text-3xl font-black text-green-700",children:U})]}),e.jsx("div",{className:"p-3 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl shadow-lg",children:e.jsx(S,{className:"h-8 w-8 text-white"})})]})}),e.jsx("div",{className:"bg-gradient-to-br from-white to-red-50 rounded-2xl shadow-xl border-2 border-red-200 p-6 hover:shadow-2xl transition-all duration-300 hover:scale-110",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-black text-red-600 uppercase tracking-wide",children:"‚ùå Ausentes"}),e.jsx("p",{className:"text-3xl font-black text-red-700",children:ae})]}),e.jsx("div",{className:"p-3 bg-gradient-to-br from-red-400 to-red-600 rounded-2xl shadow-lg",children:e.jsx(k,{className:"h-8 w-8 text-white"})})]})}),e.jsx("div",{className:"bg-gradient-to-br from-white to-blue-50 rounded-2xl shadow-xl border-2 border-blue-200 p-6 hover:shadow-2xl transition-all duration-300 hover:scale-110",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-black text-blue-600 uppercase tracking-wide",children:"üìä % Presen√ßa"}),e.jsxs("p",{className:"text-3xl font-black text-blue-700",children:[h.length>0?Math.round(U/h.length*100):0,"%"]})]}),e.jsx("div",{className:"p-3 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl shadow-lg",children:e.jsx(y,{className:"h-8 w-8 text-white"})})]})})]}),i&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["Lista de Chamada - ",(z=f.find(s=>s.id===r))==null?void 0:z.nome]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>M(!0),className:`flex items-center space-x-2 px-3 py-2 rounded-lg transition-all ${I==="todos-presentes"?"bg-green-200 text-green-800 scale-105":"bg-green-100 text-green-700 hover:bg-green-200"}`,children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx("span",{children:"Todos Presentes"})]}),e.jsxs("button",{onClick:()=>M(!1),className:`flex items-center space-x-2 px-3 py-2 rounded-lg transition-all ${I==="todos-ausentes"?"bg-red-200 text-red-800 scale-105":"bg-red-100 text-red-700 hover:bg-red-200"}`,children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:"Todos Ausentes"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm text-gray-500",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx("span",{children:new Date(o).toLocaleDateString("pt-BR")})]})]})]})}),e.jsx("div",{className:"p-6",children:h.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(P,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{children:"Nenhum aluno encontrado nesta turma"})]}):e.jsx("div",{className:"space-y-4",children:h.map(s=>{const t=g.find(n=>n.alunoId===s.id),a=t==null?void 0:t.presente;return e.jsxs("div",{className:`flex items-center justify-between p-4 border-2 rounded-lg transition-all hover:shadow-md ${a===!0?"border-green-200 bg-green-50":a===!1?"border-red-200 bg-red-50":"border-gray-200 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg ${a===!0?"bg-green-500":a===!1?"bg-red-500":"bg-blue-500"}`,children:s.nome.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-gray-900 text-lg",children:s.nome}),e.jsx("p",{className:"text-sm text-gray-500",children:a===!0?"‚úÖ Presente":a===!1?"‚ùå Ausente":"‚è≥ Aguardando"})]})]}),e.jsx("div",{className:"flex items-center space-x-3",children:p?e.jsx("button",{onClick:()=>N(s.id,!a),className:`flex items-center space-x-2 px-6 py-3 rounded-xl font-bold text-lg transition-all transform hover:scale-105 ${a?"bg-green-500 text-white hover:bg-green-600 shadow-lg":"bg-red-500 text-white hover:bg-red-600 shadow-lg"}`,children:a?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"h-5 w-5"}),e.jsx("span",{children:"Presente"})]}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-5 w-5"}),e.jsx("span",{children:"Ausente"})]})}):e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>N(s.id,!0),className:`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all transform hover:scale-105 ${a===!0?"bg-green-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-green-100 hover:text-green-700"}`,children:[e.jsx(S,{className:"h-4 w-4"}),e.jsx("span",{children:"Presente"})]}),e.jsxs("button",{onClick:()=>N(s.id,!1),className:`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all transform hover:scale-105 ${a===!1?"bg-red-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-red-100 hover:text-red-700"}`,children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{children:"Ausente"})]})]})})]},s.id)})})})]}),!i&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx(O,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Selecione uma disciplina"}),e.jsx("p",{className:"text-gray-500",children:"Escolha uma disciplina para fazer a chamada dos alunos de forma r√°pida e pr√°tica."})]})]}),!r&&e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx(y,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Selecione uma turma"}),e.jsx("p",{className:"text-gray-500",children:"Escolha uma turma e data para fazer a chamada dos alunos de forma eficiente."})]})]})}export{ue as PresencaPage};
